<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGIS - Climate Smart City</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --background-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --sidebar-bg: rgba(255, 255, 255, 0.95);
            --content-bg: rgba(255, 255, 255, 0.98);
            --accent-gradient: linear-gradient(45deg, #007bff, #00c4ff);
        }

        body {
            background: var(--background-gradient);
            min-height: 100vh;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #2d3748;
            line-height: 1.6;
        }

        .main-container {
            min-height: 100vh;
            padding: 40px 20px;
            display: flex;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .sidebar {
            background: var(--sidebar-bg);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 24px;
            width: 280px;
            position: sticky;
            top: 40px;
            height: fit-content;
            transition: transform 0.3s ease;
        }

        .sidebar h4 {
            color: var(--primary-color);
            font-weight: 700;
            font-size: 1.5rem;
            text-align: center;
            margin-bottom: 8px;
        }

        .sidebar h5 {
            color: var(--secondary-color);
            font-weight: 500;
            font-size: 1.1rem;
            text-align: center;
            margin-bottom: 20px;
        }

        .nav-link {
            color: #2d3748;
            padding: 12px 16px;
            border-radius: 12px;
            margin: 6px 0;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .nav-link:hover, .nav-link.active {
            background: var(--accent-gradient);
            color: white;
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.2);
        }

        .main-content {
            flex: 1;
            background: var(--content-bg);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 32px;
            animation: fadeIn 0.5s ease-in-out;
        }

        .accordion-item {
            border: none;
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .accordion-button {
            background: var(--accent-gradient);
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
            padding: 16px;
            border-radius: 12px !important;
            transition: all 0.3s ease;
        }

        .accordion-button:not(.collapsed) {
            background: linear-gradient(45deg, #0056b3, #007bff);
            color: white;
        }

        .accordion-button:focus {
            box-shadow: none;
            border-color: transparent;
        }

        .field-card {
            background: white;
            border-radius: 12px;
            border-left: 4px solid var(--primary-color);
            margin-bottom: 20px;
            padding: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .field-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px rgba(0, 123, 255, 0.15);
        }

        .field-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .form-floating {
            margin-bottom: 16px;
        }

        .form-control {
            border-radius: 8px;
            padding: 12px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 6px rgba(0, 123, 255, 0.2);
        }

        .btn-primary {
            background: var(--accent-gradient);
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .btn-secondary {
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
        }

        .alert {
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .tooltip-icon {
            color: var(--info-color);
            cursor: help;
            font-size: 0.9rem;
        }

        .clock-container {
            text-align: center;
            margin-bottom: 20px;
            padding: 12px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .clock-time {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .clock-date {
            font-size: 0.9rem;
            color: var(--secondary-color);
        }

        @media (max-width: 992px) {
            .main-container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                position: relative;
                top: 0;
                margin-bottom: 24px;
            }
            .main-content {
                padding: 24px;
            }
        }

        @media (max-width: 576px) {
            .accordion-button {
                font-size: 1rem;
            }
            .btn-primary, .btn-secondary {
                width: 100%;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .is-invalid {
            border-color: var(--danger-color) !important;
        }
        .is-invalid:focus {
            box-shadow: 0 0 6px rgba(220, 53, 69, 0.2);
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Sidebar -->
        <nav class="col-md-3 col-lg-2 d-md-block sidebar">
            <div class="position-sticky pt-3">
                <h4 class="text-center">WebGIS</h4>
                <h5 class="text-center">Climate Smart City</h5>
                <ul class="nav flex-column">
                    <li class="nav-item"><a class="nav-link" href="/dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/cndl"><i class="fas fa-upload"></i> Cập Nhật Dữ Liệu</a></li>
                    <% if (user && user.role === 'admin') { %>
                        <li class="nav-item"><a class="nav-link" href="/qldl"><i class="fas fa-table"></i> Quản Lý Dữ Liệu</a></li>
                        <li class="nav-item"><a class="nav-link" href="/lichsu"><i class="fas fa-history"></i> Lịch Sử</a></li>
                        <li class="nav-item"><a class="nav-link" href="/doimatkhau"><i class="fas fa-key"></i> Đổi Mật Khẩu</a></li>
                        <li class="nav-item"><a class="nav-link" href="/hsnd"><i class="fas fa-user"></i> Hồ Sơ</a></li>
                        <li class="nav-item"><a class="nav-link" href="/total-score"><i class="fas fa-calculator"></i> Tổng Điểm</a></li>
                    <% } %>
                    <li class="nav-item"><a class="nav-link" href="/xbtk"><i class="fas fa-file-export"></i> Xuất Báo Cáo</a></li>
                    <li class="nav-item"><a class="nav-link" href="/logout"><i class="fas fa-sign-out-alt"></i> Đăng Xuất</a></li>
                </ul>
                <hr>
                <div class="text-center">
                    <p>Người dùng: <strong><%= user ? user.username : 'Guest' %></strong></p>
                    <% if (user && user.role === 'admin') { %>
                        <span class="badge bg-primary">Quản trị</span>
                    <% } else { %>
                        <span class="badge bg-secondary">Người dùng</span>
                    <% } %>
                </div>
                <div class="clock-container">
                    <div class="clock-time" id="clockTime"></div>
                    <div class="clock-date" id="clockDate"></div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
<main class="main-content">
    <% if (user && user.role === 'admin') { %>
        <h2 class="mb-4">Tính toán các chỉ số môi trường</h2>
        <p class="text-muted mb-4">Nhập các giá trị để tính toán các chỉ số môi trường cho từng lĩnh vực.</p>
        <% if (error) { %>
            <div class="alert alert-danger"><%= error %></div>
        <% } %>
        <% if (success) { %>
            <div class="alert alert-success"><%= success %></div>
        <% } %>
        <form action="/cndl" method="POST" id="cndlForm">
            <input type="hidden" name="year" value="<%= year || new Date().getFullYear() %>">
            <input type="hidden" name="city" value="TP. Hồ Chí Minh">
            <div class="accordion" id="domainAccordion">
                <!-- Domain 1: Năng lượng & Công trình xanh -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading1">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse1" aria-expanded="true" aria-controls="collapse1">
                            Năng lượng & Công trình xanh
                        </button>
                    </h2>
                    <div id="collapse1" class="accordion-collapse collapse show" aria-labelledby="heading1" data-bs-parent="#domainAccordion">
                        <div class="accordion-body">
                            <!-- Indicator 1 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Tiêu thụ điện từ các nguồn năng lượng tái tạo</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Tính toán dựa trên năng lượng tái tạo và tổng tiêu thụ."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <input type="number" id="E_RE" name="ENI_RWE[params][E_RE]" class="form-control" step="any" required>
                                        <label for="E_RE">Năng lượng tái tạo sử dụng (E_RE, kWh)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="EC" name="ENI_RWE[params][EC]" class="form-control" step="any" required>
                                        <label for="EC">Tổng năng lượng tiêu thụ (EC, kWh)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="L_ATC" name="ENI_RWE[params][L_AT&C]" class="form-control" step="any" required>
                                        <label for="L_ATC">Tổn thất năng lượng (L_AT&C, kWh)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="P_RE" name="ENI_RWE[params][P_RE]" class="form-control" step="any" required>
                                        <label for="P_RE">Công suất năng lượng tái tạo (P_RE, kW)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="P_total" name="ENI_RWE[params][P_total]" class="form-control" step="any" required>
                                        <label for="P_total">Tổng công suất (P_total, kW)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="ENI_RWE">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 2 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Năng lượng tái tạo trong tổng nguồn cung năng lượng sơ cấp</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Chỉ số phần trăm năng lượng điện từ các nguồn năng lượng tái tạo trong tổng cung năng lượng."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <input type="number" id="SE_RE" name="SENIRE[params][SE_RE]" class="form-control" step="any" required>
                                        <label for="SE_RE">Tổng lượng điện từ nguồn năng lượng tái tạo trong thành phố (SE_RE, kWh)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="ES" name="SENIRE[params][ES]" class="form-control" step="any" required>
                                        <label for="ES">Tổng lượng điện cung cấp trong thành phố (ES, kWh)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="SENIRE">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 3 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Chỉ số tiết kiệm điện</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Tính toán dựa trên lượng điện tiết kiệm và tổng tiêu thụ điện."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <input type="number" id="E_Save" name="EI_Save[params][E_Save]" class="form-control" step="any" required>
                                        <label for="E_Save">Lượng điện tiết kiệm (E_Save, kWh)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="E_C" name="EI_Save[params][E_C]" class="form-control" step="any" required>
                                        <label for="E_C">Tổng tiêu thụ điện (E_C, kWh)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="EI_Save">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 4 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Hiệu quả vận hành hệ thống điện thông minh</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Tính toán dựa trên điện năng đưa vào và giao đến người tiêu dùng."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <input type="number" id="E_input" name="EI_LR[params][E_input]" class="form-control" step="any" required>
                                        <label for="E_input">Tổng sản lượng điện đưa vào (E_input, kWh)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="E_delivered" name="EI_LR[params][E_delivered]" class="form-control" step="any" required>
                                        <label for="E_delivered">Tổng điện năng giao đến (E_delivered, kWh)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="EI_LR">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 5 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Hệ thống chiếu sáng đường phố tiết kiệm năng lượng</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Tính toán dựa trên số đèn tiết kiệm năng lượng và tự động hóa."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <input type="number" id="SL_e" name="SLI[params][SL_e]" class="form-control" step="any" required>
                                        <label for="SL_e">Số đèn đường tiết kiệm năng lượng (SL_e, cái)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="SL_s" name="SLI[params][SL_s]" class="form-control" step="any" required>
                                        <label for="SL_s">Số đèn đường thông minh (SL_s, cái)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="SL" name="SLI[params][SL]" class="form-control" step="any" required>
                                        <label for="SL">Tổng số đèn đường (SL, cái)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="SLI">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 6 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Mức độ thúc đẩy các công trình xanh</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Đánh giá dựa trên chính sách thúc đẩy công trình xanh."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <select id="GBpromo" name="GBpromo[params][GBpromo]" class="form-control" required>
                                            <option value="" disabled selected>Chọn điểm</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                        <label for="GBpromo">Điểm đánh giá (GBpromo, 1-5)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="GBpromo">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 7 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Xây dựng các công trình xanh</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Tính toán dựa trên số tòa nhà xanh và diện tích xây dựng."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <input type="number" id="B_P" name="VNGBI[params][B_P]" class="form-control" step="any" required>
                                        <label for="B_P">Số tòa nhà được chứng nhận trước (B_P, cái)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="B_AC" name="VNGBI[params][B_AC]" class="form-control" step="any" required>
                                        <label for="B_AC">Số tòa nhà được phê duyệt xây dựng (B_AC, cái)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="S_GB" name="VNGBI[params][S_GB]" class="form-control" step="any" required>
                                        <label for="S_GB">Diện tích xây dựng công trình xanh (S_GB, km²)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="S_BC" name="VNGBI[params][S_BC]" class="form-control" step="any" required>
                                        <label for="S_BC">Tổng diện tích xây dựng hoàn thành (S_BC, km²)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="VNGBI">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 8 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Giảm phát thải CO2 từ tiêu thụ nhiên liệu hóa thạch</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Tính toán dựa trên lượng phát thải CO2 từ năng lượng hóa thạch."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <input type="number" id="CO2eb" name="R_CO2e[params][CO2eb]" class="form-control" step="any" required>
                                        <label for="CO2eb">Phát thải CO2 kịch bản BAU (CO2eb, tCO2e)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="CO2et" name="R_CO2e[params][CO2et]" class="form-control" step="any" required>
                                        <label for="CO2et">Phát thải CO2 kịch bản chuyển đổi (CO2et, tCO2e)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="R_CO2e">Xem trước kết quả</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Domain 2: Quy hoạch đô thị, phủ xanh & đa dạng sinh học -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading2">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse2" aria-expanded="false" aria-controls="collapse2">
                            Quy hoạch đô thị, phủ xanh & đa dạng sinh học
                        </button>
                    </h2>
                    <div id="collapse2" class="accordion-collapse collapse" aria-labelledby="heading2" data-bs-parent="#domainAccordion">
                        <div class="accordion-body">
                            <!-- Indicator 9 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Mức độ quy hoạch, bảo vệ và phát triển mặt nước & không gian mở</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Tính toán dựa trên diện tích mặt nước và không gian mở."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <input type="number" id="S_water_present" name="R_S_water[params][S_water_present]" class="form-control" step="any" required>
                                        <label for="S_water_present">Diện tích mặt nước hiện tại (S_water_present, ha)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="S_water_plan" name="R_S_water[params][S_water_plan]" class="form-control" step="any" required>
                                        <label for="S_water_plan">Diện tích mặt nước quy hoạch (S_water_plan, ha)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="S_op_present" name="R_S_water[params][S_op_present]" class="form-control" step="any" required>
                                        <label for="S_op_present">Diện tích không gian mở hiện tại (S_op_present, ha)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="S_op_plan" name="R_S_water[params][S_op_plan]" class="form-control" step="any" required>
                                        <label for="S_op_plan">Diện tích không gian mở quy hoạch (S_op_plan, ha)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="R_S_water">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 10 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Tỷ lệ phủ xanh trong thành phố</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Tính toán dựa trên diện tích cây xanh công cộng và dân số."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <input type="number" id="S_pp" name="Rcover[params][S_pp]" class="form-control" step="any" required>
                                        <label for="S_pp">Diện tích cây xanh công cộng (S_pp, m²)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="P" name="Rcover[params][P]" class="form-control" step="any" required>
                                        <label for="P">Tổng dân số (P, người)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="Rcover">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 11 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Tỷ lệ đất cây xanh đô thị trên tổng diện tích đất xây dựng đô thị</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Tính toán dựa trên diện tích đất cây xanh và tổng diện tích đất xây dựng."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <input type="number" id="S_land_p" name="Rland_p[params][S_land_p]" class="form-control" step="any" required>
                                        <label for="S_land_p">Diện tích đất cây xanh đô thị (S_land_p, ha)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="S_total_land" name="Rland_p[params][S_total_land]" class="form-control" step="any" required>
                                        <label for="S_total_land">Tổng diện tích đất xây dựng đô thị (S_total_land, ha)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="Rland_p">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 12 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Đa dạng sinh học đô thị</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Tính toán dựa trên diện tích tự nhiên và phục hồi sinh thái."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <input type="number" id="A_natural" name="UBI_PNRA[params][A_natural]" class="form-control" step="any" required>
                                        <label for="A_natural">Diện tích khu vực tự nhiên (A_natural, ha)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="A_restored" name="UBI_PNRA[params][A_restored]" class="form-control" step="any" required>
                                        <label for="A_restored">Diện tích khu vực phục hồi sinh thái (A_restored, ha)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="A_city" name="UBI_PNRA[params][A_city]" class="form-control" step="any" required>
                                        <label for="A_city">Tổng diện tích thành phố (A_city, ha)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="UBI_PNRA">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 13 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Ứng dụng GIS và dữ liệu số trong quy hoạch đô thị</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Đánh giá mức độ ứng dụng GIS trong quy hoạch."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <select id="GISapp" name="GISapp[params][GISapp]" class="form-control" required>
                                            <option value="" disabled selected>Chọn điểm</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                        <label for="GISapp">Điểm đánh giá (GISapp, 1-5)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="GISapp">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 14 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Hệ thống cảnh báo & quản lý thiên tai thông minh</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Đánh giá hệ thống cảnh báo thiên tai."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <select id="DISaster" name="DISaster[params][DISaster]" class="form-control" required>
                                            <option value="" disabled selected>Chọn điểm</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                        <label for="DISaster">Điểm đánh giá (DISaster, 1-5)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="DISaster">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 15 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Kế hoạch hành động về khí hậu</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Đánh giá chất lượng kế hoạch hành động khí hậu."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <select id="ClimateAct" name="ClimateAct[params][ClimateAct]" class="form-control" required>
                                            <option value="" disabled selected>Chọn điểm</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                        <label for="ClimateAct">Điểm đánh giá (ClimateAct, 1-5)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="ClimateAct">Xem trước kết quả</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Domain 3: Giao thông đô thị & chất lượng không khí -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading3">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse3" aria-expanded="false" aria-controls="collapse3">
                            Giao thông đô thị & chất lượng không khí
                        </button>
                    </h2>
                    <div id="collapse3" class="accordion-collapse collapse" aria-labelledby="heading3" data-bs-parent="#domainAccordion">
                        <div class="accordion-body">
                            <!-- Indicator 16 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Tỷ lệ bao phủ mạng lưới giao thông phi cơ giới</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Tỷ lệ đường dành cho xe đạp và đi bộ."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <input type="number" id="NMT_L" name="NMT[params][NMT_L]" class="form-control" step="any" required>
                                        <label for="NMT_L">Chiều dài mạng lưới giao thông phi cơ giới (NMT_L, km)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="L_R" name="NMT[params][L_R]" class="form-control" step="any" required>
                                        <label for="L_R">Tổng chiều dài mạng lưới giao thông (L_R, km)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="NMT">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 17 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Tỷ lệ phương tiện công cộng ứng dụng công nghệ sạch</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Tính toán dựa trên số phương tiện công cộng sạch."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <input type="number" id="PT_c" name="PT_c[params][PT_c]" class="form-control" step="any" required>
                                        <label for="PT_c">Số phương tiện công cộng sạch (PT_c, phương tiện)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="PT" name="PT_c[params][PT]" class="form-control" step="any" required>
                                        <label for="PT">Tổng số phương tiện công cộng (PT, phương tiện)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="PT_c">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 18 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Mức độ dễ tiếp cận phương tiện công cộng</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Tính toán dựa trên số phương tiện công cộng trên 1000 dân."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <input type="number" id="PT_F" name="PT1000[params][PT_F]" class="form-control" step="any" required>
                                        <label for="PT_F">Số lượng phương tiện công cộng (PT_F, phương tiện)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="P" name="PT1000[params][P]" class="form-control" step="any" required>
                                        <label for="P">Dân số ước tính (P, người)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="PT1000">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 19 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Tỷ lệ hệ thống đèn tín hiệu giao thông thông minh</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Tính toán dựa trên số đèn giao thông thông minh."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <input type="number" id="STL_S" name="STL[params][STL_S]" class="form-control" step="any" required>
                                        <label for="STL_S">Số đèn giao thông thông minh (STL_S, chốt đèn)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="TL" name="STL[params][TL]" class="form-control" step="any" required>
                                        <label for="TL">Tổng số đèn giao thông (TL, chốt đèn)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="STL">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 20 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Tỷ lệ đường phố tích hợp cảnh báo & thông tin giao thông trực tuyến</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Tính toán dựa trên chiều dài đường có thông tin giao thông trực tuyến."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <input type="number" id="SRRW_L" name="SRRW[params][SRRW_L]" class="form-control" step="any" required>
                                        <label for="SRRW_L">Chiều dài đường có thông tin giao thông trực tuyến (SRRW_L, km)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="TSR" name="SRRW[params][TSR]" class="form-control" step="any" required>
                                        <label for="TSR">Tổng chiều dài đường phố (TSR, km)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="SRRW">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 21 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Khả năng thông hành và mức phục vụ của đường phố</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Đánh giá mức độ phục vụ của đường phố."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <select id="RoadCap" name="RoadCap[params][RoadCap]" class="form-control" required>
                                            <option value="" disabled selected>Chọn điểm</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                        <label for="RoadCap">Điểm đánh giá (RoadCap, 1-5)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="RoadCap">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 22 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Mật độ trạm quan trắc không khí tự động, liên tục</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Tính toán dựa trên số trạm quan trắc trên diện tích."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <input type="number" id="AQstation" name="AQstation[params][AQstation]" class="form-control" step="any" required>
                                        <label for="AQstation">Số trạm quan trắc không khí (AQstation, trạm)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="A_city" name="AQstation[params][A_city]" class="form-control" step="any" required>
                                        <label for="A_city">Tổng diện tích thành phố (A_city, ha)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="AQstation">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 23 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Khả năng cung cấp dữ liệu & cảnh báo AQI thời gian thực</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Đánh giá khả năng cung cấp dữ liệu AQI."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <select id="AQdata" name="AQdata[params][AQdata]" class="form-control" required>
                                            <option value="" disabled selected>Chọn điểm</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                        <label for="AQdata">Điểm đánh giá (AQdata, 1-5)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="AQdata">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 24 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Kế hoạch hành động vì không khí sạch</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Đánh giá chất lượng kế hoạch không khí sạch."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <select id="CleanAirPlan" name="CleanAirPlan[params][CleanAirPlan]" class="form-control" required>
                                            <option value="" disabled selected>Chọn điểm</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                        <label for="CleanAirPlan">Điểm đánh giá (CleanAirPlan, 1-5)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="CleanAirPlan">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 25 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Mức độ ô nhiễm không khí (số ngày AQI vượt ngưỡng)</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Tính toán dựa trên số ngày AQI vượt ngưỡng."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <input type="number" id="AQI_exceed_days" name="AQI_TDE[params][AQI_exceed_days]" class="form-control" step="any" required>
                                        <label for="AQI_exceed_days">Số ngày AQI vượt ngưỡng (AQI_exceed_days, ngày)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="AQI_TDE">Xem trước kết quả</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Domain 4: Quản lý nước -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading4">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse4" aria-expanded="false" aria-controls="collapse4">
                            Quản lý nước
                        </button>
                    </h2>
                    <div id="collapse4" class="accordion-collapse collapse" aria-labelledby="heading4" data-bs-parent="#domainAccordion">
                        <div class="accordion-body">
                            <!-- Indicator 26 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Đánh giá mức độ quản lý tài nguyên nước</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Đánh giá hiệu quả quản lý nước."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <select id="WImanage" name="WImanage[params][WImanage]" class="form-control" required>
                                            <option value="" disabled selected>Chọn điểm</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                        <label for="WImanage">Điểm đánh giá (WImanage, 1-5)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="WImanage">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 27 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Chỉ số giảm thất thoát nguồn nước</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Tính toán dựa trên lượng nước sản xuất và nước bán."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <input type="number" id="W_P" name="WI_loss[params][W_P]" class="form-control" step="any" required>
                                        <label for="W_P">Lượng nước sản xuất (W_P, m³/tháng)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="W_S" name="WI_loss[params][W_S]" class="form-control" step="any" required>
                                        <label for="W_S">Lượng nước bán (W_S, m³/tháng)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="WI_loss">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 28 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Chỉ số tái sử dụng nước thải</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Tính toán dựa trên lượng nước thải tái sử dụng và nước cấp."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <input type="number" id="W_rr" name="WI_rr[params][W_rr]" class="form-control" step="any" required>
                                        <label for="W_rr">Lượng nước thải tái sử dụng (W_rr, m³)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="W_s" name="WI_rr[params][W_s]" class="form-control" step="any" required>
                                        <label for="W_s">Lượng nước cấp (W_s, m³)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="WI_rr">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 29 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Quản lý rủi ro ngập lụt đô thị</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Đánh giá quản lý rủi ro ngập lụt."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <select id="FloodRisk" name="FloodRisk[params][FloodRisk]" class="form-control" required>
                                            <option value="" disabled selected>Chọn điểm</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                        <label for="FloodRisk">Điểm đánh giá (FloodRisk, 1-5)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="FloodRisk">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 30 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Hệ thống cấp nước sạch tiết kiệm năng lượng</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Đánh giá hiệu quả năng lượng của hệ thống cấp nước."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <select id="Ewater" name="Ewater[params][Ewater]" class="form-control" required>
                                            <option value="" disabled selected>Chọn điểm</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                        <label for="Ewater">Điểm đánh giá (Ewater, 1-5)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="Ewater">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 31 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Hệ thống quản lý nước thải tiết kiệm năng lượng</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Đánh giá hiệu quả năng lượng của hệ thống nước thải."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <select id="Ewwater" name="Ewwater[params][Ewwater]" class="form-control" required>
                                            <option value="" disabled selected>Chọn điểm</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                        <label for="Ewwater">Điểm đánh giá (Ewwater, 1-5)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="Ewwater">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 32 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Ứng dụng công nghệ số trong quản lý nước</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Đánh giá mức độ số hóa trong quản lý nước."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <select id="DigWater" name="DigWater[params][DigWater]" class="form-control" required>
                                            <option value="" disabled selected>Chọn điểm</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                        <label for="DigWater">Điểm đánh giá (DigWater, 1-5)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="DigWater">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 33 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Tỷ lệ tiếp cận nước sạch đô thị</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Tính toán dựa trên số dân được cấp nước an toàn."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <input type="number" id="P_W" name="R_USWA[params][P_W]" class="form-control" step="any" required>
                                        <label for="P_W">Số dân được cấp nước an toàn (P_W, người)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="P_S" name="R_USWA[params][P_S]" class="form-control" step="any" required>
                                        <label for="P_S">Tổng dân số phục vụ (P_S, người)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="R_USWA">Xem trước kết quả</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Domain 5: Quản lý chất thải -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading5">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse5" aria-expanded="false" aria-controls="collapse5">
                            Quản lý chất thải
                        </button>
                    </h2>
                    <div id="collapse5" class="accordion-collapse collapse" aria-labelledby="heading5" data-bs-parent="#domainAccordion">
                        <div class="accordion-body">
                            <!-- Indicator 34 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Các sáng kiến giảm thiểu chất thải</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Số lượng sáng kiến giảm thiểu chất thải."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <input type="number" id="Waste_Init" name="WasteInit[params][Waste_Init]" class="form-control" step="any" required>
                                        <label for="Waste_Init">Số sáng kiến giảm thiểu (Waste_Init, sáng kiến)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="WasteInit">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 35 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Tỷ lệ chôn lấp rác thải sinh hoạt</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Tính toán dựa trên lượng rác thải chôn lấp và tổng rác thải."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <input type="number" id="W_landfill" name="R_USWA_waste[params][W_landfill]" class="form-control" step="any" required>
                                        <label for="W_landfill">Lượng rác thải chôn lấp (W_landfill, tấn)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="W_waste_generate" name="R_USWA_waste[params][W_waste_generate]" class="form-control" step="any" required>
                                        <label for="W_waste_generate">Tổng lượng rác thải sinh hoạt (W_waste_generate, tấn)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="R_USWA_waste">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 36 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Mức độ rác thải khô được thu hồi và tái chế</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Tính toán dựa trên lượng rác thải tái chế và tái sử dụng."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <input type="number" id="W_RU" name="RRWI[params][W_RU]" class="form-control" step="any" required>
                                        <label for="W_RU">Lượng rác thải tái sử dụng (W_RU, tấn/năm)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="W_RRC" name="RRWI[params][W_RRC]" class="form-control" step="any" required>
                                        <label for="W_RRC">Lượng rác thải tái chế (W_RRC, tấn/năm)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="W_G" name="RRWI[params][W_G]" class="form-control" step="any" required>
                                        <label for="W_G">Tổng lượng rác thải sinh ra (W_G, tấn/năm)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="RRWI">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 37 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Quản lý chất thải xây dựng</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Tính toán dựa trên lượng chất thải xây dựng được xử lý và tái chế."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <input type="number" id="W_Cons_deli_cp" name="ConsWaste[params][W_Cons_deli_cp]" class="form-control" step="any" required>
                                        <label for="W_Cons_deli_cp">Chất thải xây dựng chuyển đến điểm tập kết (W_Cons_deli_cp, tấn)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="W_Cons" name="ConsWaste[params][W_Cons]" class="form-control" step="any" required>
                                        <label for="W_Cons">Tổng chất thải xây dựng phát sinh (W_Cons, tấn)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="W_Cons_rr" name="ConsWaste[params][W_Cons_rr]" class="form-control" step="any" required>
                                        <label for="W_Cons_rr">Chất thải xây dựng tái chế/tái sử dụng (W_Cons_rr, tấn)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="W_Cons_deli_reduce" name="ConsWaste[params][W_Cons_deli_reduce]" class="form-control" step="any" required>
                                        <label for="W_Cons_deli_reduce">Chất thải xây dựng chuyển đến cơ sở xử lý (W_Cons_deli_reduce, tấn)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="ConsWaste">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 38 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Mức độ xử lý chất thải ướt</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Tính toán dựa trên lượng chất thải ướt được xử lý."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <input type="number" id="W_T" name="WWT_I[params][W_T]" class="form-control" step="any" required>
                                        <label for="W_T">Lượng chất thải ướt xử lý (W_T, tấn)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="W_G" name="WWT_I[params][W_G]" class="form-control" step="any" required>
                                        <label for="W_G">Tổng lượng chất thải ướt sinh ra (W_G, tấn)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="WWT_I">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 39 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Chỉ số chuyển đổi số trong quản lý chất thải</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Đánh giá mức độ số hóa trong quản lý chất thải."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <select id="DigWaste" name="DigWaste[params][DigWaste]" class="form-control" required>
                                            <option value="" disabled selected>Chọn điểm</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                        <label for="DigWaste">Điểm đánh giá (DigWaste, 1-5)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="DigWaste">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 40 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Hiệu quả vận hành bãi chôn lấp</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Đánh giá hiệu quả vận hành bãi chôn lấp."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <select id="LandfillEff" name="LandfillEff[params][LandfillEff]" class="form-control" required>
                                            <option value="" disabled selected>Chọn điểm</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                        <label for="LandfillEff">Điểm đánh giá (LandfillEff, 1-5)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="LandfillEff">Xem trước kết quả</button>
                                </div>
                            </div>
                            <!-- Indicator 41 -->
                            <div class="field-card">
                                <div class="field-header">
                                    <h5>Cải thiện phát thải khí nhà kính trong quản lý chất thải</h5>
                                    <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Tính toán dựa trên lượng giảm phát thải khí nhà kính từ các phương pháp xử lý chất thải."></i>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-floating">
                                        <input type="number" id="GHGs_Landfill" name="GHGIs[params][GHGs_Landfill]" class="form-control" step="any" required>
                                        <label for="GHGs_Landfill">Giảm phát thải từ chôn lấp (GHGs_Landfill, tCO₂e/ngày)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="GHGs_WTE" name="GHGIs[params][GHGs_WTE]" class="form-control" step="any" required>
                                        <label for="GHGs_WTE">Giảm phát thải từ đốt phát điện (GHGs_WTE, tCO₂e/ngày)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="GHGs_Recycling" name="GHGIs[params][GHGs_Recycling]" class="form-control" step="any" required>
                                        <label for="GHGs_Recycling">Giảm phát thải từ tái chế (GHGs_Recycling, tCO₂e/ngày)</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" id="GHGs_Composting" name="GHGIs[params][GHGs_Composting]" class="form-control" step="any" required>
                                        <label for="GHGs_Composting">Giảm phát thải từ xử lý sinh học (GHGs_Composting, tCO₂e/ngày)</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-2 preview-btn" data-indicator="GHGIs">Xem trước kết quả</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <button type="submit" class="btn btn-primary mt-3">Lưu Dữ Liệu</button>
        </form>
    <% } else { %>
        <div class="alert alert-warning">Bạn không có quyền truy cập chức năng này.</div>
    <% } %>
</main>
</div>

    <!-- Preview Modal -->
    <div class="modal fade preview-modal" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="previewModalLabel">Kết quả xem trước</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Giá trị:</strong> <span id="previewValue"></span></p>
                    <p><strong>Cấp độ:</strong> <span id="previewLevel"></span></p>
                    <p><strong>Điểm:</strong> <span id="previewScore"></span></p>
                    <p><strong>Mô tả:</strong> <span id="previewDescription"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Enable tooltips
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltipTriggerList.forEach(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

    // Real-time clock
    function updateClock() {
        const now = new Date();
        const options = {
            timeZone: 'Asia/Ho_Chi_Minh',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true,
        };
        const dateOptions = {
            timeZone: 'Asia/Ho_Chi_Minh',
            weekday: 'long',
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
        };
        const timeString = now.toLocaleTimeString('vi-VN', options);
        const dateString = now.toLocaleDateString('vi-VN', dateOptions);
        document.getElementById('clockTime').textContent = timeString;
        document.getElementById('clockDate').textContent = dateString;
    }
    updateClock();
    const clockInterval = setInterval(updateClock, 1000);
    window.addEventListener('unload', () => clearInterval(clockInterval));

    // Calculate preview with client-side validation
    async function calculatePreview(indicatorCode) {
        const form = document.getElementById('cndlForm');
        // Lấy field-card chứa nút preview
        const button = document.querySelector(`button[data-indicator="${indicatorCode}"]`);
        const fieldCard = button.closest('.field-card');
        const inputs = fieldCard.querySelectorAll(`[name^="${indicatorCode}[params]"]`);
        const params = {};

        // Validate inputs
        let isValid = true;
        inputs.forEach(input => {
            const paramName = input.name.match(/$$ params $$$$ (.+) $$/)?.[1];
            const value = input.value.trim();

            if (!paramName) {
                console.error(`Invalid input name for indicator ${indicatorCode}: ${input.name}`);
                isValid = false;
                input.classList.add('is-invalid');
                return;
            }

            if (!value) {
                isValid = false;
                input.classList.add('is-invalid');
                return;
            } else if (input.type === 'number' && isNaN(parseFloat(value))) {
                isValid = false;
                input.classList.add('is-invalid');
                return;
            } else {
                input.classList.remove('is-invalid');
                params[paramName] = input.type === 'number' ? parseFloat(value) : value;
            }
        });

        if (!isValid) {
            alert('Vui lòng điền đầy đủ và đúng định dạng các trường bắt buộc.');
            return;
        }

        try {
            const token = document.cookie.split('; ').find(row => row.startsWith('token='))?.split('=')[1];
            if (!token) {
                alert('Không tìm thấy token. Vui lòng đăng nhập lại.');
                return;
            }

            const response = await fetch('/cndl/preview', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                },
                body: JSON.stringify({
                    indicatorCode,
                    params,
                    year: form.querySelector('[name="year"]').value || new Date().getFullYear(),
                    city: form.querySelector('[name="city"]').value || 'TP. Hồ Chí Minh',
                }),
            });

            const result = await response.json();

            if (response.ok) {
                document.getElementById('previewValue').textContent = result.value || 'N/A';
                document.getElementById('previewLevel').textContent = result.level || 'N/A';
                document.getElementById('previewScore').textContent = result.score || 'N/A';
                document.getElementById('previewDescription').textContent = result.description || 'Không có mô tả';

                const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
                previewModal.show();
            } else {
                console.error('Preview error:', result.message);
                alert(result.message || 'Có lỗi xảy ra khi tính toán. Vui lòng thử lại.');
            }
        } catch (error) {
            console.error('Error during preview:', error);
            alert('Không thể kết nối đến server. Vui lòng kiểm tra kết nối mạng và thử lại.');
        }
    }

    // Attach click event to preview buttons
    document.querySelectorAll('.preview-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const indicatorCode = btn.getAttribute('data-indicator');
            if (!indicatorCode) {
                console.error('No data-indicator attribute found on button');
                alert('Lỗi: Không tìm thấy mã chỉ số');
                return;
            }
            calculatePreview(indicatorCode);
        });
    });

    // Form submission validation
    document.getElementById('cndlForm').addEventListener('submit', function (event) {
        const inputs = this.querySelectorAll('input[required], select[required]');
        let isValid = true;

        inputs.forEach(input => {
            if (!input.value.trim()) {
                isValid = false;
                input.classList.add('is-invalid');
            } else {
                input.classList.remove('is-invalid');
            }
        });

        if (!isValid) {
            event.preventDefault();
            alert('Vui lòng điền đầy đủ tất cả các trường bắt buộc.');
        }
    });
</script>
</body>
</html>